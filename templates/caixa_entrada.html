<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa de Entrada - Workflow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .card-header { font-weight: bold; }
        .status-badge { font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container mt-4">
    
    <div class="alert alert-warning d-flex align-items-center justify-content-between">
        <div>
            <strong>Modo de Teste:</strong> Simule quem está logado.
        </div>
        <div class="d-flex align-items-center">
            <label class="me-2">ID Usuário:</label>
            <input type="number" id="idUsuarioLogado" class="form-control form-control-sm" value="1" style="width: 80px;">
            <button class="btn btn-sm btn-dark ms-2" onclick="carregarTarefas()">Atualizar</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">Iniciar Novo Processo</div>
                <div class="card-body">
                    <label>ID do Modelo de Processo:</label>
                    <input type="number" id="idModeloInit" class="form-control mb-3" placeholder="Ex: 1">
                    <button class="btn btn-success w-100" onclick="iniciarProcesso()">
                        <i class="bi bi-play-circle"></i> Iniciar Processo
                    </button>
                    <small class="text-muted d-block mt-2">Isso criará a instância e gerará a 1ª tarefa para o cargo responsável.</small>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    Minhas Tarefas Pendentes
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Protocolo</th>
                                <th>Processo</th>
                                <th>Etapa Atual</th>
                                <th>Data Início</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaTarefas">
                            </tbody>
                    </table>
                    <div id="loading" class="text-center p-3 d-none">Carregando...</div>
                    <div id="noData" class="text-center p-3 d-none text-muted">Nenhuma tarefa pendente para o seu cargo.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExecucao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Executar Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="idTarefaAtual">
                
                <div class="mb-3">
                    <label class="form-label">Observações / Parecer:</label>
                    <textarea class="form-control" id="textoSaida" rows="3" placeholder="Descreva o resultado da tarefa..."></textarea>
                </div>
                
                <div class="alert alert-info" role="alert">
                    Ao concluir, o processo avançará automaticamente para a próxima etapa (se houver).
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarConclusao()">Concluir Tarefa</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // URL Base da sua API (ajuste se seu blueprint tiver prefixo diferente)
    // Supondo que no app.py você registrou: app.register_blueprint(..., url_prefix='/processo')
    const API_BASE = '/processo/api'; 

    document.addEventListener("DOMContentLoaded", () => {
        carregarTarefas();
    });

    // 1. CARREGAR TAREFAS
    async function carregarTarefas() {
        const idUsuario = document.getElementById('idUsuarioLogado').value;
        const tbody = document.getElementById('tabelaTarefas');
        const loading = document.getElementById('loading');
        const noData = document.getElementById('noData');

        tbody.innerHTML = '';
        loading.classList.remove('d-none');
        noData.classList.add('d-none');

        try {
            const response = await fetch(`${API_BASE}/minhas-tarefas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_usuario: idUsuario })
            });
            const data = await response.json();

            loading.classList.add('d-none');

            if (data.sucess && data.tarefas.length > 0) {
                data.tarefas.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="badge bg-secondary">${t.codigo_processo || 'N/A'}-${t.id_instancia}</span></td>
                        <td>${t.nome_processo}</td>
                        <td><strong>${t.tarefa_atual}</strong><br><small class="text-muted">${t.descricao_etapa || ''}</small></td>
                        <td>${t.data_inicio}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="abrirModal(${t.id_tarefa})">
                                Executar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                noData.classList.remove('d-none');
            }

        } catch (error) {
            console.error(error);
            alert("Erro ao carregar tarefas.");
            loading.classList.add('d-none');
        }
    }

    // 2. INICIAR PROCESSO
    async function iniciarProcesso() {
        const idModelo = document.getElementById('idModeloInit').value;
        const idUsuario = document.getElementById('idUsuarioLogado').value;

        if(!idModelo) return alert("Informe o ID do Modelo.");

        try {
            const response = await fetch(`${API_BASE}/iniciar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id_modelo: idModelo,
                    id_criador: idUsuario 
                })
            });
            const data = await response.json();

            if(data.sucess) {
                alert(data.message);
                carregarTarefas(); // Recarrega a lista
            } else {
                alert("Erro: " + data.message);
            }
        } catch (e) {
            console.error(e);
            alert("Erro de conexão.");
        }
    }

    // 3. ABRIR MODAL
    let modalInstance;
    function abrirModal(idTarefa) {
        document.getElementById('idTarefaAtual').value = idTarefa;
        document.getElementById('textoSaida').value = ''; // Limpa anterior
        
        const modalEl = document.getElementById('modalExecucao');
        modalInstance = new bootstrap.Modal(modalEl);
        modalInstance.show();
    }

    // 4. CONFIRMAR CONCLUSÃO
    async function confirmarConclusao() {
        const idTarefa = document.getElementById('idTarefaAtual').value;
        const idUsuario = document.getElementById('idUsuarioLogado').value;
        const texto = document.getElementById('textoSaida').value;

        try {
            const response = await fetch(`${API_BASE}/concluir-tarefa`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id_tarefa: idTarefa,
                    id_usuario: idUsuario,
                    texto_saida: texto
                })
            });
            const data = await response.json();

            if(data.sucess) {
                alert(data.message);
                modalInstance.hide();
                carregarTarefas(); // Atualiza a lista para ver se a tarefa sumiu
            } else {
                alert("Erro: " + data.message);
            }

        } catch (e) {
            console.error(e);
            alert("Erro ao concluir tarefa.");
        }
    }
</script>

</body>
</html>