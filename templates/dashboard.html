<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Processos | Secretaria da Mulher PE</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           ESTILOS GERAIS (Identidade Visual)
           ========================================= */
        :root {
            --primary-color: #6f42c1;
            --primary-hover: #59359a;
            --bg-body: #f8f9fa;
            --text-color: #333333;
            --card-bg: #ffffff;
            --navbar-bg: rgba(255, 255, 255, 0.95);
            --navbar-text: #333;
            --border-color: #dee2e6;
        }

        [data-theme="dark"] {
            --primary-color: #9d6ce0;
            --primary-hover: #b589f0;
            --bg-body: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --navbar-bg: rgba(30, 30, 30, 0.95);
            --navbar-text: #f8f9fa;
            --border-color: #444;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-color); 
            transition: 0.3s; 
            padding-top: 80px; /* Espaço para a navbar fixa */
        }
        
        /* Navbar */
        .navbar { background-color: var(--navbar-bg); backdrop-filter: blur(10px); padding: 15px 0; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .navbar-brand { color: var(--primary-color) !important; font-weight: 700; }
        .nav-link { color: var(--navbar-text) !important; font-weight: 500; }
        .nav-link.active { color: var(--primary-color) !important; font-weight: 700; }
        .btn-theme-toggle { border: 1px solid var(--navbar-text); color: var(--navbar-text); width: 40px; height: 40px; border-radius: 50%; background: transparent; display: flex; align-items: center; justify-content: center; }

        /* Containers e Cards */
        .main-container { max-width: 1200px; margin: 30px auto; }
        .card { background-color: var(--card-bg); border: none; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { background-color: rgba(111, 66, 193, 0.05); border-bottom: 1px solid var(--border-color); color: var(--primary-color); font-weight: 600; padding: 15px 20px; }

        /* Barra de Simulação (Dev Tools) */
        .simulation-bar {
            background: linear-gradient(135deg, #343a40, #212529);
            color: #fff;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Botões e Inputs */
        .btn-primary-custom { background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; transition: 0.3s; width: 100%; }
        .btn-primary-custom:hover { background-color: var(--primary-hover); color: white; transform: translateY(-2px); }
        
        .form-select-lg { border-radius: 10px; border-color: var(--border-color); background-color: var(--card-bg); color: var(--text-color); font-size: 0.95rem; }

        /* Tabela */
        .table { color: var(--text-color); margin-bottom: 0; }
        .table thead th { background: transparent; border-bottom: 2px solid var(--border-color); color: var(--primary-color); font-weight: 600; }
        .table td, .table th { border-color: var(--border-color); vertical-align: middle; padding: 12px; }
        
        /* Badges de Status */
        .badge-status-concluido { background-color: #198754; color: white; }
        .badge-status-andamento { background-color: #ffc107; color: #333; }
        .badge-custom { padding: 6px 10px; border-radius: 6px; font-weight: 500; font-size: 0.8rem; }

        .loading-overlay { display: flex; justify-content: center; padding: 2rem; color: var(--primary-color); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fa-solid fa-scale-balanced me-2"></i>
                Sec. Mulher PE
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(0.5);"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Administração</a>
                        <ul class="dropdown-menu border-0 shadow">
                            <li><a class="dropdown-item" href="/cargo/">Novo Cargo</a></li>
                            <li><a class="dropdown-item" href="/funcionario/">Novo Funcionário</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">Processos</a>
                        <ul class="dropdown-menu border-0 shadow">
                            <li><a class="dropdown-item" href="/modelo/processo">Novo Modelo</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item active" href="/processo/dashboard"><strong>Iniciar Processo</strong></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Relatórios</a>
                    </li>
                    <li class="nav-item ms-lg-3 mt-3 mt-lg-0">
                        <button class="btn-theme-toggle" id="darkModeToggle" title="Alternar Tema">
                            <i class="fa-solid fa-moon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        
        <div class="simulation-bar d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fa-solid fa-robot me-2 fs-5"></i>
                <span class="fw-bold">Ambiente de Simulação</span>
            </div>
            <div class="d-flex align-items-center">
                <small class="me-2 text-white-50">Logado como ID:</small>
                <input type="number" id="idUsuarioLogado" class="form-control form-control-sm text-center bg-dark text-white border-secondary" value="1" style="width: 70px;">
            </div>
        </div>

        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="fa-solid fa-play me-2"></i>Novo Processo
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Selecione um modelo abaixo para iniciar uma nova instância de fluxo de trabalho.</p>
                        
                        <div class="mb-3">
                            <label for="selectModelo" class="form-label fw-bold small text-muted">SELECIONE O MODELO</label>
                            <select id="selectModelo" class="form-select form-select-lg">
                                <option value="" selected disabled>Carregando modelos...</option>
                            </select>
                        </div>

                        <div class="d-grid mt-4">
                            <button class="btn-primary-custom shadow-sm" onclick="iniciarProcesso()">
                                <i class="fa-solid fa-paper-plane me-2"></i> Iniciar Agora
                            </button>
                        </div>

                        <hr class="my-4" style="opacity: 0.1">
                        
                        <div class="d-flex align-items-start text-muted">
                            <i class="fa-solid fa-circle-info mt-1 me-2 text-primary"></i>
                            <small style="font-size: 0.8rem;">
                                A primeira tarefa será encaminhada automaticamente para a caixa de entrada do responsável configurado no fluxo.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center bg-transparent">
                        <span><i class="fa-solid fa-list-check me-2"></i>Instâncias em Andamento</span>
                        <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="carregarInstancias()">
                            <i class="fa-solid fa-rotate me-1"></i> Atualizar
                        </button>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 10%; padding-left: 20px;">ID</th>
                                        <th style="width: 35%;">Processo</th>
                                        <th style="width: 20%;">Criador</th>
                                        <th style="width: 20%;">Status</th>
                                        <th style="width: 15%; text-align: right; padding-right: 20px;">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaInstancias">
                                    </tbody>
                            </table>
                        </div>

                        <div id="loading" class="loading-overlay d-none">
                            <div class="spinner-border" role="status"></div>
                        </div>
                        <div id="msgVazio" class="text-center p-5 text-muted d-none">
                            <i class="fa-solid fa-inbox fa-3x mb-3 opacity-50"></i>
                            <p>Nenhum processo iniciado.</p>
                        </div>
                        <div id="msgErro" class="text-center p-4 text-danger d-none">
                            <i class="fa-solid fa-triangle-exclamation me-2"></i> Erro ao carregar dados.
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =========================================
        // 1. DARK MODE (Mesma lógica das outras páginas)
        // =========================================
        const toggleButton = document.getElementById('darkModeToggle');
        const body = document.body;
        const icon = toggleButton.querySelector('i');

        if (localStorage.getItem('theme') === 'dark') {
            body.setAttribute('data-theme', 'dark');
            icon.classList.replace('fa-moon', 'fa-sun');
        }

        toggleButton.addEventListener('click', () => {
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        });

        // =========================================
        // 2. LÓGICA DO DASHBOARD
        // =========================================
        const URL_GET_MODELOS = '/modelo/processo/all'; 
        const URL_GET_INSTANCIAS = '/processo/api/todas-instancias';
        const URL_INICIAR = '/processo/api/iniciar';

        document.addEventListener("DOMContentLoaded", () => {
            carregarModelos();    
            carregarInstancias(); 
        });

        // --- Carregar Modelos no Select ---
        async function carregarModelos() {
            const select = document.getElementById('selectModelo');
            
            try {
                const response = await fetch(URL_GET_MODELOS);
                if(!response.ok) throw new Error("Falha na requisição");
                
                const data = await response.json();
                select.innerHTML = '<option value="" selected disabled>Selecione um modelo...</option>';

                // Tratamento flexível para o formato da resposta
                let listaModelos = [];
                if (data.modelos && Array.isArray(data.modelos)) {
                    listaModelos = data.modelos; // Formato { sucess: true, modelos: [...] }
                } else if (Array.isArray(data)) {
                    listaModelos = data; // Formato direto [...]
                }

                if (listaModelos.length > 0) {
                    listaModelos.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = m.nome_processo || m.nome || `Modelo #${m.id}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option disabled>Nenhum modelo disponível</option>';
                }

            } catch (error) {
                console.error("Erro ao carregar modelos:", error);
                select.innerHTML = '<option disabled>Erro de conexão</option>';
            }
        }

        // --- Carregar Tabela de Instâncias ---
        async function carregarInstancias() {
            const tbody = document.getElementById('tabelaInstancias');
            const loading = document.getElementById('loading');
            const msgVazio = document.getElementById('msgVazio');
            const msgErro = document.getElementById('msgErro');

            tbody.innerHTML = '';
            loading.classList.remove('d-none');
            msgVazio.classList.add('d-none');
            msgErro.classList.add('d-none');

            try {
                const response = await fetch(URL_GET_INSTANCIAS);
                if(!response.ok) throw new Error("Erro servidor");
                
                const data = await response.json();
                loading.classList.add('d-none');

                if (!data || data.length === 0) {
                    msgVazio.classList.remove('d-none');
                    return;
                }

                data.forEach(instancia => {
                    const tr = document.createElement('tr');
                    
                    // Lógica visual do status
                    let badgeClass = 'badge-status-andamento';
                    let iconStatus = '<i class="fa-solid fa-hourglass-half me-1"></i>';
                    
                    if (instancia.status === 'Concluído' || instancia.status_cod === 1) {
                        badgeClass = 'badge-status-concluido';
                        iconStatus = '<i class="fa-solid fa-check me-1"></i>';
                    }

                    tr.innerHTML = `
                        <td class="fw-bold" style="padding-left: 20px;">#${instancia.id}</td>
                        <td>
                            <div class="fw-bold">${instancia.nome_processo || 'Sem Nome'}</div>
                            <small class="text-muted" style="font-size: 0.75rem"><i class="fa-regular fa-calendar me-1"></i> ${instancia.data_inicio}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded-circle p-1 me-2 border d-flex justify-content-center align-items-center" style="width:30px; height:30px">
                                    <i class="fa-solid fa-user text-secondary" style="font-size: 0.8rem"></i>
                                </div>
                                <small>${instancia.criado_por}</small>
                            </div>
                        </td>
                        <td><span class="badge badge-custom ${badgeClass}">${iconStatus}${instancia.status}</span></td>
                        <td class="text-end" style="padding-right: 20px;">
                            <button class="btn btn-sm btn-outline-primary" onclick="abrirDetalhes(${instancia.id})" title="Acompanhar">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error("Erro instâncias:", error);
                loading.classList.add('d-none');
                msgErro.classList.remove('d-none');
            }
        }

        // --- Iniciar Processo ---
        async function iniciarProcesso() {
            const select = document.getElementById('selectModelo');
            const idModelo = select.value;
            const idUsuario = document.getElementById('idUsuarioLogado').value;
            
            if (!idModelo) {
                alert("Selecione um Modelo de Processo.");
                select.focus();
                return;
            }

            const btn = document.querySelector('button[onclick="iniciarProcesso()"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Iniciando...';
            btn.disabled = true;

            try {
                const response = await fetch(URL_INICIAR, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id_modelo: idModelo,
                        id_criador: idUsuario 
                    })
                });

                const result = await response.json();

                if (result.sucess) {
                    // Feedback visual rápido (opcional: toast)
                    select.value = ""; 
                    carregarInstancias(); 
                } else {
                    alert("Erro ao iniciar: " + (result.message || "Desconhecido"));
                }

            } catch (error) {
                console.error(error);
                alert("Erro de conexão.");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // --- Abrir Detalhes (Redirecionamento) ---
        function abrirDetalhes(idInstancia) {
            const idUser = document.getElementById('idUsuarioLogado').value || 1;
            window.location.href = `/processo/detalhes/${idInstancia}?uid=${idUser}`;
        }
    </script>
</body>
</html>